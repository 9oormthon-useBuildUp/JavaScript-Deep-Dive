# 13장 스코프

### ⛅ 스코프란?

- 스코프는 변수와 함수에 깊은 관련이 있다.
- 모든 식별자는 자신이 선언된 위치에 의해 다른 코드가 식별자 자신을 참조할 수 있는 유효범위가 결정되는데, 이를 스코프라고 한다.<br>
  스코프 => 식별자가 유효한 범위!!
- 자바스크립트 엔진이 식별자를 검색할 때 사용하는 규칙!
- 자바스크립트 엔진은 코드를 실행할 때 코드의 문맥을 고려함
- 스코프라는 것이 없다면 프로그램 전체에서 동일한 변수의 이름은 하나밖에 사용하지 못하게 됨!
- 스코프 내에서 식별자는 유일해야 하지만, 다른 스코프에는 같은 이름의 식별자 사용 가능!<br>
  (스코프 == 네임스페이스)
- 이때 `var` 키워드는 같은 스코프내에 중복 선언이 가능하기때문에 유의해야함! 👀

```javascript
// 자바스크립트 엔진은 이름이 같은 두 개의 변수 중에서 어떤 변수를 참조해야 할것인지를 결정
// => 식별자 결정 이라고함!
var x = 'global';

function foo() {
  var x = 'local';
  console.log(x);
}

foo();

console.log(x);

// 이 예제는 이름이 동일한 식별자를 console.log로 찍지만
// 스코프가 다른 별개의 변수를 말하고 있음
```

```ABAP
❓렉시컬 환경과 실행 컨텍스트❓

- 코드가 어디서 실행되며 주변에 어떤 코드가 있는지를 렉시컬 환경이라고 함
- 코드의 문맥은 렉시컬 환경으로 이루어짐
- 렉시컬 환경을 구현한 것이 실행 컨텍스트임
  => 모든 코드는 실행 컨텍스트에서 평가되고 실행됨
```

### ⛅️ 스코프의 종류

#### 전역과 전역 스코프

- 전역이란 코드의 가장 바깥 영역을 말함
- 전역은 전역 스코프를 만듬
- 전역에 변수를 선언하면 전역변수가 된다.
- 전역 변수는 어디서든지 참조 가능
- 아래의 예제에서 x,y는 전역변수이므로 함수 내부에서도 참조 가능!

```javascript
var x = 'global x';
var y = 'global y';

function outer() {
  var z = "outer's local z";

  console.log(x);
  console.log(y);
  console.log(z);

  function inner() {
    var x = "inner's local x";

    console.log(x);
    console.log(y);
    console.log(z);
  }

  inner();
}

outer();

console.log(x);
console.log(z);
```

#### 지역과 지역 스코프

- 지역이란 함수 몸체 내부를 말함
- 지역은 지역 스코프를 만든다.
- 지역에 변수를 선언하면 지역 스코프를 갖는 지역 변수가 된다.
- 지역변수는 자신이 선언된 영역과 하위 지역 에서만 참조 가능<br>
  => 지역변수는 자신의 지역 스코프 + 하위 지역 스코프 에서 유효
- 자바스크립트 엔진은 스코프 체인을 통해 참조할 변수를 검색한다. 따라서 위예제처럼 전역변수가 아닌 지역변수를 참조함

### 스코프 체인

- 함수 몸체 내부에서 함수가 정의된 것을 **함수의 중첩** 이라고 한다.
- 함수 몸체 내부에서 정의한 함수 === 중첩 함수
- 중첩 함수를 포함하는 함수 === 외부 함수
- 따라서 함수가 중첩이 된다는 말은 **함수의 지역 스코프도 중첩**될 수 있다는 뜻!
- 이는 스코프가 함수의 중첩에 의해 **계층적인 구조를 갖는다**는 것을 의미함!
- 계층적인 구조로 연결된 것을 스코프 체인이라고 하는데, 위의 예제에서는 <br>
  (전역 스코프 <== outer 지역 스코프 <== inner 지역 스코프) 구조로 이루어 져있다.

```ABAP
🔥 변수를 참조할때 자바스크립트 엔진은 스코프 체인을 통해 변수를 참조하는 코드의 스코프에서 시작하여
상위 스코프 방향으로 이동하면서 선언된 변수를 검색 한다.
```

- 스코프 체인은 물리적인 실체로 존재하는데 자바스크립트 엔진은 코드를 실행하기 전 계층적인 구조로 이루어진 자료구조를 실제로 생성한다!
- 그 자료구조의 이름은 렉시컬 환경!

```ABAP
💡 렉시컬 환경
   - 변수 선언: 변수 식별자가 이 자료구조(렉시컬 환경)에 키로 등록
   - 변수 할당: 이 자료구조의 변수 식별자에 해당하는 값을 변경
   - 스코프 체인은 실행 컨텍스트의 렉시컬 환경을 단방향으로 연결한 것
   - 함수가 호출되면 곧바로 생성됨!
```

#### 스코프 체인에 의한 변수 검색

- 위 예제의 inner 함수 내부에서 호출된 console.log 를 살펴보면 어떻게 변수를 검색하는지 알 수 있음!
- `console.log(x)`: inner 함수에서 x 변수의 선언 검색 -> x 변수 존재하므로 검색된 변수 참조 후 검색 종료
- `console.log(y)`: inner 검색 -> outer 검색 -> 전역 검색 -> y 변수 존재 하므로 변수 참조 후 검색 종료
- `console.log(z)`: inner 검색 -> outer 검색 -> z 변수 존재 하므로 변수 참조 후 검색 종료
- 이렇게 상위 스코프 방향으로 이동하며 선언된 변수를 검색함
- 이는 상위 스코프에서 유효한 변수는 하위스코프에처 참조 🅾️, 하위 스코프에서 유효한 변수를 상위스코프에서 참조 ❌

#### 스코프 체인에 의한 함수 검색

- 함수도 식별자에 해당하기 때문에 스코프를 갖는다.
- 함수는 식별자에 함수 객체가 할당된 것 외에는 일반 변수와 다를 바가 없으므로 스코프체인이 동일하게 식별자를 검색함

```javascript
function foo() {
  console.log('global');
}

function bar() {
  // 중첩 함수
  function foo() {
    console.log('local');
  }
  foo();
}

bar();
```

### 함수 레벨 스코프

- 지역은 함수 몸체 내부를 말하며 지역 스코프를 만든다.
- 즉, **코드 블록이 아닌 함수에 의해서만 지역 스코프가 생긴다!!**
- `if`, `for`, `while`, `try/catch` 등 을 자바스크립트에서는 **블록 레벨 스코프** 라고 함
- `var` 키워드로 선언된 변수는 오직 함수의 코드블록 만을 지역 스코프로 인정함!! => **함수 레벨 스코프**

```javascript
var x = 1;

if (true) {
  // var 키워드로 선언된 변수는 함수 레벨 스코프만 인정하므로 if문 같은 경우에는 블록레벨 스코프이다.
  // 따라서 아래의 x변수는 전역변수와 같음!
  // 재선언이 되었을 뿐이다!
  var x = 10;
}

console.log(x); // 10

// 아래의 예제는 전역변수 i를 선언한 후에 for문에서 재할당이 이루어짐
// var 키워드는 블록레벨스코프라면 같은 변수(같은 스코프)로 취급하기 때문!
var i = 10;

for (var i = 0; i < 5; i++) {
  console.log(i); // 0 1 2 3 4
}

console.log(i); // 5
```

### 렉시컬 스코프

- 동적 스코프 방식: 함수를 어디서 호출했는지에 따라 함수의 상위 스코프를 결정
- 정적 스코프 방식(렉시컬 스코프): 상위 스코프가 동적으로 변하지 안혹 **함수 정의가 평가되는 시점에 상위 스코프가 정적으로 결정**됨
- 자바스크립트는 렉시컬 스코프를 따른다!
- 따라서 **함수를 어디서 정의 했는지에 따라 상위 스코프를 결정한다!**
- 호출된 위치는 상위 스코프 결정에 어떠한 영향도 ❌ => 함수의 상위 스코프 === 언제나 자신이 정의된 스코프
- **함수 정의가 실행되어 생성된 함수 객체는 결정된 상위 스코프를 기억한다! => 함수가 호출될 때마다 함수의 상위 스코프를 참조해야 하기 때문!**

```javascript
// 렉시컬 스코프 예제

var x = 1;

function foo() {
  var x = 10;
  bar();
}

function bar() {
  console.log(x);
}

foo(); // 1
bar(); // 1
```
